import socket
import time
from pymodbus.client import ModbusSerialClient

"""
Creating Socket Objects
ë³¸ í”„ë¡œê·¸ë¨ì´ ëŒì•„ê°€ëŠ” PCì˜ IP address, Portë¥¼ ì…ë ¥
"""
HOST = 'localhost' #hostname 127.0.0.1
PORT = 8080 #Portnumber

# Modbus RTU Client ì„¤ì •
modbus_client = ModbusSerialClient( port='COM3', baudrate=9600, stopbits=1)

# TCP ì†Œì¼“ ì—´ê¸°
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as server_socket:
    server_socket.bind((HOST, PORT))
    server_socket.listen(1)
    print(f"Adapter listening on {HOST}:{PORT}...")

    while True:
        conn, addr = server_socket.accept()
        print(f"Connection from {addr} established")
        with conn:
            while True:
                # PLCì—ì„œ ë°ì´í„° ì½ê¸°
                if modbus_client.connect():
                    result = modbus_client.read_holding_registers(address=0, count=10)
                    if not result.isError():
                        plc_data = result.registers
                        timestamp = time.strftime("%Y-%m-%dT%H:%M:%S", time.gmtime())
                        mtconnect_data = f"TIME|{timestamp}\nDATA|PLC_Data|{plc_data[0]}\n"

                        # MTConnect Agentë¡œ ë°ì´í„° ì „ì†¡
                        conn.sendall(mtconnect_data.encode('utf-8'))
                        print(f"Sent data: {mtconnect_data}")
                    modbus_client.close()

                # ë°ì´í„° ì†¡ì‹  í›„ 1ì´ˆ ëŒ€ê¸°
                time.sleep(1)


ğŸ“Œ port='COM3': ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ë¥¼ ì„¤ì • (ì¥ì¹˜ ê´€ë¦¬ìì—ì„œ í™•ì¸ ê°€ëŠ¥)
ğŸ“Œ baudrate=9600: ì¥ì¹˜ì™€ ì¼ì¹˜í•˜ëŠ” ë³´ë“œë ˆì´íŠ¸ ì„¤ì •.
ğŸ“Œ parity, stopbits, bytesize: ìŠ¬ë ˆì´ë¸Œ ì¥ì¹˜ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
ğŸ“Œ read_holding_registers: Modbus ìŠ¬ë ˆì´ë¸Œì˜ í™€ë”© ë ˆì§€ìŠ¤í„° ì½ê¸°
